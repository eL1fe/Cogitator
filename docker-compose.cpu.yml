# Docker Compose for CPU-only systems (no NVIDIA GPU)
# Usage: docker-compose -f docker-compose.cpu.yml up -d

services:
  # PostgreSQL - Primary database for agents, runs, workflows, swarms
  postgres:
    image: pgvector/pgvector:pg16
    container_name: cogitator-postgres
    environment:
      POSTGRES_USER: cogitator
      POSTGRES_PASSWORD: cogitator_dev
      POSTGRES_DB: cogitator
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cogitator -d cogitator"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis - Cache, events, short-term memory
  redis:
    image: redis:7-alpine
    container_name: cogitator-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Ollama - Local LLM runtime (CPU only)
  ollama:
    image: ollama/ollama:latest
    container_name: cogitator-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    # No GPU configuration - runs on CPU

  # Ollama model initialization
  ollama-init:
    image: ollama/ollama:latest
    container_name: cogitator-ollama-init
    depends_on:
      ollama:
        condition: service_started
    volumes:
      - ollama_data:/root/.ollama
    environment:
      OLLAMA_HOST: ollama:11434
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "‚è≥ Waiting for Ollama to be ready..."
        sleep 10
        
        echo "üì¶ Pulling embedding model: nomic-embed-text..."
        ollama pull nomic-embed-text
        
        echo "üì¶ Pulling default LLM: llama3.2:3b..."
        ollama pull llama3.2:3b
        
        echo "‚úÖ Models ready!"
        ollama list
    restart: "no"

volumes:
  postgres_data:
    name: cogitator_postgres_data
  redis_data:
    name: cogitator_redis_data
  ollama_data:
    name: cogitator_ollama_data

networks:
  default:
    name: cogitator_network

