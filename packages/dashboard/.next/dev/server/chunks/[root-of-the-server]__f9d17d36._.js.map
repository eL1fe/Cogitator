{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 48, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Projects/Cogitator/packages/dashboard/src/lib/db/index.ts"],"sourcesContent":["import { Pool, PoolClient } from 'pg';\n\nlet pool: Pool | null = null;\n\nexport function getPool(): Pool {\n  if (!pool) {\n    pool = new Pool({\n      host: process.env.POSTGRES_HOST || 'localhost',\n      port: parseInt(process.env.POSTGRES_PORT || '5432'),\n      user: process.env.POSTGRES_USER || 'cogitator',\n      password: process.env.POSTGRES_PASSWORD || 'cogitator',\n      database: process.env.POSTGRES_DB || 'cogitator',\n      max: 20,\n      idleTimeoutMillis: 30000,\n      connectionTimeoutMillis: 2000,\n    });\n  }\n  return pool;\n}\n\nexport async function query<T>(sql: string, params?: unknown[]): Promise<T[]> {\n  const pool = getPool();\n  const result = await pool.query(sql, params);\n  return result.rows as T[];\n}\n\nexport async function queryOne<T>(sql: string, params?: unknown[]): Promise<T | null> {\n  const rows = await query<T>(sql, params);\n  return rows[0] || null;\n}\n\nexport async function execute(sql: string, params?: unknown[]): Promise<number> {\n  const pool = getPool();\n  const result = await pool.query(sql, params);\n  return result.rowCount || 0;\n}\n\nexport async function withTransaction<T>(fn: (client: PoolClient) => Promise<T>): Promise<T> {\n  const pool = getPool();\n  const client = await pool.connect();\n  \n  try {\n    await client.query('BEGIN');\n    const result = await fn(client);\n    await client.query('COMMIT');\n    return result;\n  } catch (error) {\n    await client.query('ROLLBACK');\n    throw error;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function initializeSchema(): Promise<void> {\n  const pool = getPool();\n  \n  await pool.query(`\n    -- Agents table\n    CREATE TABLE IF NOT EXISTS dashboard_agents (\n      id TEXT PRIMARY KEY,\n      name TEXT NOT NULL,\n      model TEXT NOT NULL,\n      description TEXT,\n      instructions TEXT,\n      status TEXT DEFAULT 'offline' CHECK (status IN ('online', 'offline', 'busy')),\n      total_runs INTEGER DEFAULT 0,\n      total_tokens BIGINT DEFAULT 0,\n      total_cost DECIMAL(12, 6) DEFAULT 0,\n      last_run_at TIMESTAMPTZ,\n      created_at TIMESTAMPTZ DEFAULT NOW(),\n      updated_at TIMESTAMPTZ DEFAULT NOW()\n    );\n\n    -- Runs table\n    CREATE TABLE IF NOT EXISTS dashboard_runs (\n      id TEXT PRIMARY KEY,\n      agent_id TEXT NOT NULL REFERENCES dashboard_agents(id) ON DELETE CASCADE,\n      thread_id TEXT,\n      status TEXT DEFAULT 'running' CHECK (status IN ('running', 'completed', 'failed', 'cancelled')),\n      input TEXT NOT NULL,\n      output TEXT,\n      started_at TIMESTAMPTZ DEFAULT NOW(),\n      completed_at TIMESTAMPTZ,\n      duration INTEGER,\n      input_tokens INTEGER DEFAULT 0,\n      output_tokens INTEGER DEFAULT 0,\n      total_tokens INTEGER DEFAULT 0,\n      cost DECIMAL(12, 6) DEFAULT 0,\n      error TEXT\n    );\n\n    -- Tool calls table\n    CREATE TABLE IF NOT EXISTS dashboard_tool_calls (\n      id TEXT PRIMARY KEY,\n      run_id TEXT NOT NULL REFERENCES dashboard_runs(id) ON DELETE CASCADE,\n      name TEXT NOT NULL,\n      arguments JSONB,\n      result JSONB,\n      status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'success', 'error')),\n      duration INTEGER,\n      started_at TIMESTAMPTZ DEFAULT NOW(),\n      completed_at TIMESTAMPTZ,\n      error TEXT\n    );\n\n    -- Spans table (for tracing)\n    CREATE TABLE IF NOT EXISTS dashboard_spans (\n      id TEXT PRIMARY KEY,\n      run_id TEXT NOT NULL REFERENCES dashboard_runs(id) ON DELETE CASCADE,\n      trace_id TEXT NOT NULL,\n      parent_id TEXT,\n      name TEXT NOT NULL,\n      kind TEXT DEFAULT 'internal',\n      status TEXT DEFAULT 'unset' CHECK (status IN ('ok', 'error', 'unset')),\n      start_time BIGINT NOT NULL,\n      end_time BIGINT,\n      duration INTEGER,\n      attributes JSONB,\n      events JSONB\n    );\n\n    -- Logs table\n    CREATE TABLE IF NOT EXISTS dashboard_logs (\n      id TEXT PRIMARY KEY,\n      timestamp TIMESTAMPTZ DEFAULT NOW(),\n      level TEXT NOT NULL CHECK (level IN ('debug', 'info', 'warn', 'error')),\n      message TEXT NOT NULL,\n      source TEXT,\n      agent_id TEXT,\n      run_id TEXT,\n      metadata JSONB\n    );\n\n    -- Messages table (conversation history)\n    CREATE TABLE IF NOT EXISTS dashboard_messages (\n      id TEXT PRIMARY KEY,\n      run_id TEXT NOT NULL REFERENCES dashboard_runs(id) ON DELETE CASCADE,\n      role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system', 'tool')),\n      content TEXT NOT NULL,\n      tool_call_id TEXT,\n      created_at TIMESTAMPTZ DEFAULT NOW()\n    );\n\n    -- Config table (key-value store)\n    CREATE TABLE IF NOT EXISTS dashboard_config (\n      key TEXT PRIMARY KEY,\n      value JSONB NOT NULL,\n      updated_at TIMESTAMPTZ DEFAULT NOW()\n    );\n\n    -- Indexes\n    CREATE INDEX IF NOT EXISTS idx_dashboard_runs_agent_id ON dashboard_runs(agent_id);\n    CREATE INDEX IF NOT EXISTS idx_dashboard_runs_status ON dashboard_runs(status);\n    CREATE INDEX IF NOT EXISTS idx_dashboard_runs_started_at ON dashboard_runs(started_at DESC);\n    CREATE INDEX IF NOT EXISTS idx_dashboard_tool_calls_run_id ON dashboard_tool_calls(run_id);\n    CREATE INDEX IF NOT EXISTS idx_dashboard_spans_run_id ON dashboard_spans(run_id);\n    CREATE INDEX IF NOT EXISTS idx_dashboard_spans_trace_id ON dashboard_spans(trace_id);\n    CREATE INDEX IF NOT EXISTS idx_dashboard_logs_timestamp ON dashboard_logs(timestamp DESC);\n    CREATE INDEX IF NOT EXISTS idx_dashboard_logs_level ON dashboard_logs(level);\n    CREATE INDEX IF NOT EXISTS idx_dashboard_logs_run_id ON dashboard_logs(run_id);\n    CREATE INDEX IF NOT EXISTS idx_dashboard_messages_run_id ON dashboard_messages(run_id);\n  `);\n}\n\nexport async function closePool(): Promise<void> {\n  if (pool) {\n    await pool.end();\n    pool = null;\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;;;;;AAEA,IAAI,OAAoB;AAEjB,SAAS;IACd,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qMAAI,CAAC;YACd,MAAM,QAAQ,GAAG,CAAC,aAAa,IAAI;YACnC,MAAM,SAAS,QAAQ,GAAG,CAAC,aAAa,IAAI;YAC5C,MAAM,QAAQ,GAAG,CAAC,aAAa,IAAI;YACnC,UAAU,QAAQ,GAAG,CAAC,iBAAiB,IAAI;YAC3C,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;YACrC,KAAK;YACL,mBAAmB;YACnB,yBAAyB;QAC3B;IACF;IACA,OAAO;AACT;AAEO,eAAe,MAAS,GAAW,EAAE,MAAkB;IAC5D,MAAM,OAAO;IACb,MAAM,SAAS,MAAM,KAAK,KAAK,CAAC,KAAK;IACrC,OAAO,OAAO,IAAI;AACpB;AAEO,eAAe,SAAY,GAAW,EAAE,MAAkB;IAC/D,MAAM,OAAO,MAAM,MAAS,KAAK;IACjC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,GAAW,EAAE,MAAkB;IAC3D,MAAM,OAAO;IACb,MAAM,SAAS,MAAM,KAAK,KAAK,CAAC,KAAK;IACrC,OAAO,OAAO,QAAQ,IAAI;AAC5B;AAEO,eAAe,gBAAmB,EAAsC;IAC7E,MAAM,OAAO;IACb,MAAM,SAAS,MAAM,KAAK,OAAO;IAEjC,IAAI;QACF,MAAM,OAAO,KAAK,CAAC;QACnB,MAAM,SAAS,MAAM,GAAG;QACxB,MAAM,OAAO,KAAK,CAAC;QACnB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,MAAM,OAAO,KAAK,CAAC;QACnB,MAAM;IACR,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,MAAM,OAAO;IAEb,MAAM,KAAK,KAAK,CAAC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAyGlB,CAAC;AACH;AAEO,eAAe;IACpB,IAAI,MAAM;QACR,MAAM,KAAK,GAAG;QACd,OAAO;IACT;AACF"}},
    {"offset": {"line": 325, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Projects/Cogitator/packages/dashboard/src/lib/redis.ts"],"sourcesContent":["import Redis from 'ioredis';\n\nlet redis: Redis | null = null;\nlet subscriber: Redis | null = null;\n\nexport function getRedis(): Redis {\n  if (!redis) {\n    redis = new Redis({\n      host: process.env.REDIS_HOST || 'localhost',\n      port: parseInt(process.env.REDIS_PORT || '6379'),\n      maxRetriesPerRequest: 3,\n      lazyConnect: true,\n    });\n  }\n  return redis;\n}\n\nexport function getSubscriber(): Redis {\n  if (!subscriber) {\n    subscriber = new Redis({\n      host: process.env.REDIS_HOST || 'localhost',\n      port: parseInt(process.env.REDIS_PORT || '6379'),\n      maxRetriesPerRequest: 3,\n      lazyConnect: true,\n    });\n  }\n  return subscriber;\n}\n\nexport async function publish(channel: string, message: unknown): Promise<void> {\n  const client = getRedis();\n  await client.publish(channel, JSON.stringify(message));\n}\n\nexport async function subscribe(\n  channel: string,\n  callback: (message: unknown) => void\n): Promise<() => void> {\n  const sub = getSubscriber();\n  \n  await sub.subscribe(channel);\n  \n  const handler = (ch: string, msg: string) => {\n    if (ch === channel) {\n      try {\n        callback(JSON.parse(msg));\n      } catch {\n        callback(msg);\n      }\n    }\n  };\n  \n  sub.on('message', handler);\n  \n  return () => {\n    sub.off('message', handler);\n    sub.unsubscribe(channel);\n  };\n}\n\nexport async function cache<T>(\n  key: string,\n  fn: () => Promise<T>,\n  ttlSeconds = 60\n): Promise<T> {\n  const client = getRedis();\n  \n  const cached = await client.get(key);\n  if (cached) {\n    return JSON.parse(cached) as T;\n  }\n  \n  const result = await fn();\n  await client.setex(key, ttlSeconds, JSON.stringify(result));\n  \n  return result;\n}\n\nexport async function invalidateCache(pattern: string): Promise<void> {\n  const client = getRedis();\n  const keys = await client.keys(pattern);\n  if (keys.length > 0) {\n    await client.del(...keys);\n  }\n}\n\nexport async function closeRedis(): Promise<void> {\n  if (redis) {\n    await redis.quit();\n    redis = null;\n  }\n  if (subscriber) {\n    await subscriber.quit();\n    subscriber = null;\n  }\n}\n\n// Real-time channels\nexport const CHANNELS = {\n  RUN_STARTED: 'cogitator:run:started',\n  RUN_COMPLETED: 'cogitator:run:completed',\n  RUN_FAILED: 'cogitator:run:failed',\n  LOG_ENTRY: 'cogitator:log:entry',\n  AGENT_STATUS: 'cogitator:agent:status',\n  TOOL_CALL: 'cogitator:tool:call',\n} as const;\n\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;;AAEA,IAAI,QAAsB;AAC1B,IAAI,aAA2B;AAExB,SAAS;IACd,IAAI,CAAC,OAAO;QACV,QAAQ,IAAI,0MAAK,CAAC;YAChB,MAAM,QAAQ,GAAG,CAAC,UAAU,IAAI;YAChC,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;YACzC,sBAAsB;YACtB,aAAa;QACf;IACF;IACA,OAAO;AACT;AAEO,SAAS;IACd,IAAI,CAAC,YAAY;QACf,aAAa,IAAI,0MAAK,CAAC;YACrB,MAAM,QAAQ,GAAG,CAAC,UAAU,IAAI;YAChC,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;YACzC,sBAAsB;YACtB,aAAa;QACf;IACF;IACA,OAAO;AACT;AAEO,eAAe,QAAQ,OAAe,EAAE,OAAgB;IAC7D,MAAM,SAAS;IACf,MAAM,OAAO,OAAO,CAAC,SAAS,KAAK,SAAS,CAAC;AAC/C;AAEO,eAAe,UACpB,OAAe,EACf,QAAoC;IAEpC,MAAM,MAAM;IAEZ,MAAM,IAAI,SAAS,CAAC;IAEpB,MAAM,UAAU,CAAC,IAAY;QAC3B,IAAI,OAAO,SAAS;YAClB,IAAI;gBACF,SAAS,KAAK,KAAK,CAAC;YACtB,EAAE,OAAM;gBACN,SAAS;YACX;QACF;IACF;IAEA,IAAI,EAAE,CAAC,WAAW;IAElB,OAAO;QACL,IAAI,GAAG,CAAC,WAAW;QACnB,IAAI,WAAW,CAAC;IAClB;AACF;AAEO,eAAe,MACpB,GAAW,EACX,EAAoB,EACpB,aAAa,EAAE;IAEf,MAAM,SAAS;IAEf,MAAM,SAAS,MAAM,OAAO,GAAG,CAAC;IAChC,IAAI,QAAQ;QACV,OAAO,KAAK,KAAK,CAAC;IACpB;IAEA,MAAM,SAAS,MAAM;IACrB,MAAM,OAAO,KAAK,CAAC,KAAK,YAAY,KAAK,SAAS,CAAC;IAEnD,OAAO;AACT;AAEO,eAAe,gBAAgB,OAAe;IACnD,MAAM,SAAS;IACf,MAAM,OAAO,MAAM,OAAO,IAAI,CAAC;IAC/B,IAAI,KAAK,MAAM,GAAG,GAAG;QACnB,MAAM,OAAO,GAAG,IAAI;IACtB;AACF;AAEO,eAAe;IACpB,IAAI,OAAO;QACT,MAAM,MAAM,IAAI;QAChB,QAAQ;IACV;IACA,IAAI,YAAY;QACd,MAAM,WAAW,IAAI;QACrB,aAAa;IACf;AACF;AAGO,MAAM,WAAW;IACtB,aAAa;IACb,eAAe;IACf,YAAY;IACZ,WAAW;IACX,cAAc;IACd,WAAW;AACb"}},
    {"offset": {"line": 432, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Projects/Cogitator/packages/dashboard/src/app/api/health/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { getPool } from '@/lib/db';\nimport { getRedis } from '@/lib/redis';\n\nexport async function GET() {\n  const health: {\n    status: 'healthy' | 'degraded' | 'unhealthy';\n    services: {\n      database: { status: 'up' | 'down'; latency?: number };\n      redis: { status: 'up' | 'down'; latency?: number };\n      ollama: { status: 'up' | 'down'; models?: string[] };\n    };\n    uptime: number;\n    timestamp: string;\n  } = {\n    status: 'healthy',\n    services: {\n      database: { status: 'down' },\n      redis: { status: 'down' },\n      ollama: { status: 'down' },\n    },\n    uptime: process.uptime(),\n    timestamp: new Date().toISOString(),\n  };\n\n  // Check PostgreSQL\n  try {\n    const pool = getPool();\n    const start = Date.now();\n    await pool.query('SELECT 1');\n    health.services.database = {\n      status: 'up',\n      latency: Date.now() - start,\n    };\n  } catch {\n    health.services.database = { status: 'down' };\n    health.status = 'degraded';\n  }\n\n  // Check Redis\n  try {\n    const redis = getRedis();\n    const start = Date.now();\n    await redis.ping();\n    health.services.redis = {\n      status: 'up',\n      latency: Date.now() - start,\n    };\n  } catch {\n    health.services.redis = { status: 'down' };\n    health.status = 'degraded';\n  }\n\n  // Check Ollama\n  try {\n    const ollamaUrl = process.env.OLLAMA_URL || 'http://localhost:11434';\n    const response = await fetch(`${ollamaUrl}/api/tags`, {\n      signal: AbortSignal.timeout(5000),\n    });\n    if (response.ok) {\n      const data = await response.json();\n      health.services.ollama = {\n        status: 'up',\n        models: data.models?.map((m: { name: string }) => m.name) || [],\n      };\n    }\n  } catch {\n    health.services.ollama = { status: 'down' };\n    // Ollama is optional, don't mark as degraded\n  }\n\n  // If database is down, system is unhealthy\n  if (health.services.database.status === 'down') {\n    health.status = 'unhealthy';\n  }\n\n  const statusCode = health.status === 'healthy' ? 200 : \n                     health.status === 'degraded' ? 200 : 503;\n\n  return NextResponse.json(health, { status: statusCode });\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEO,eAAe;IACpB,MAAM,SASF;QACF,QAAQ;QACR,UAAU;YACR,UAAU;gBAAE,QAAQ;YAAO;YAC3B,OAAO;gBAAE,QAAQ;YAAO;YACxB,QAAQ;gBAAE,QAAQ;YAAO;QAC3B;QACA,QAAQ,QAAQ,MAAM;QACtB,WAAW,IAAI,OAAO,WAAW;IACnC;IAEA,mBAAmB;IACnB,IAAI;QACF,MAAM,OAAO,IAAA,+JAAO;QACpB,MAAM,QAAQ,KAAK,GAAG;QACtB,MAAM,KAAK,KAAK,CAAC;QACjB,OAAO,QAAQ,CAAC,QAAQ,GAAG;YACzB,QAAQ;YACR,SAAS,KAAK,GAAG,KAAK;QACxB;IACF,EAAE,OAAM;QACN,OAAO,QAAQ,CAAC,QAAQ,GAAG;YAAE,QAAQ;QAAO;QAC5C,OAAO,MAAM,GAAG;IAClB;IAEA,cAAc;IACd,IAAI;QACF,MAAM,QAAQ,IAAA,0JAAQ;QACtB,MAAM,QAAQ,KAAK,GAAG;QACtB,MAAM,MAAM,IAAI;QAChB,OAAO,QAAQ,CAAC,KAAK,GAAG;YACtB,QAAQ;YACR,SAAS,KAAK,GAAG,KAAK;QACxB;IACF,EAAE,OAAM;QACN,OAAO,QAAQ,CAAC,KAAK,GAAG;YAAE,QAAQ;QAAO;QACzC,OAAO,MAAM,GAAG;IAClB;IAEA,eAAe;IACf,IAAI;QACF,MAAM,YAAY,QAAQ,GAAG,CAAC,UAAU,IAAI;QAC5C,MAAM,WAAW,MAAM,MAAM,GAAG,UAAU,SAAS,CAAC,EAAE;YACpD,QAAQ,YAAY,OAAO,CAAC;QAC9B;QACA,IAAI,SAAS,EAAE,EAAE;YACf,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,OAAO,QAAQ,CAAC,MAAM,GAAG;gBACvB,QAAQ;gBACR,QAAQ,KAAK,MAAM,EAAE,IAAI,CAAC,IAAwB,EAAE,IAAI,KAAK,EAAE;YACjE;QACF;IACF,EAAE,OAAM;QACN,OAAO,QAAQ,CAAC,MAAM,GAAG;YAAE,QAAQ;QAAO;IAC1C,6CAA6C;IAC/C;IAEA,2CAA2C;IAC3C,IAAI,OAAO,QAAQ,CAAC,QAAQ,CAAC,MAAM,KAAK,QAAQ;QAC9C,OAAO,MAAM,GAAG;IAClB;IAEA,MAAM,aAAa,OAAO,MAAM,KAAK,YAAY,MAC9B,OAAO,MAAM,KAAK,aAAa,MAAM;IAExD,OAAO,qPAAY,CAAC,IAAI,CAAC,QAAQ;QAAE,QAAQ;IAAW;AACxD"}}]
}